<?xml version="1.0" encoding="UTF-8"?>
<mxfile host="app.diagrams.net">
  <diagram name="Corrected Podcast Flow" id="corrected-podcast-flow">
    <mxGraphModel dx="1200" dy="900" grid="1" gridSize="10" page="1" pageWidth="1200" pageHeight="900">
      <root>
        <mxCell id="0"/>
        <mxCell id="1" parent="0"/>

        <!-- Entry -->
        <mxCell id="2" value="Entrypoints&#10;1) graph.py CLI (_cli_main) [graph 14.2]&#10;2) lkk.py CLI (run_podcast) [lkk 10.2]&#10;3) lkk.py FastAPI (serve) [lkk 9.1]" style="rounded=1;fillColor=#1f78b4;fontColor=#ffffff;strokeColor=#0b4f7a;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="40" y="40" width="300" height="110" as="geometry"/>
        </mxCell>

        <!-- Config & Context -->
        <mxCell id="3" value="Config Manager&#10;- Env & voice params" style="rounded=1;fillColor=#8b5cf6;fontColor=#ffffff;strokeColor=#5b21b6;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="360" y="40" width="220" height="90" as="geometry"/>
        </mxCell>

        <mxCell id="4" value="Context Manager&#10;- list_json_files()&#10;- load_context()&#10;- infer_topic_from_metrics()" style="rounded=1;fillColor=#f59e0b;fontColor=#000000;strokeColor=#92400e;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="360" y="150" width="220" height="110" as="geometry"/>
        </mxCell>

        <!-- Orchestrator -->
        <mxCell id="5" value="LangGraph Orchestrator&#10;- _build_compiled_graph() [graph 10.2]&#10;- generate_podcast() [graph 13.1]&#10;- _run_with_events() [graph 12.1]" style="rounded=1;fillColor=#16a34a;fontColor=#ffffff;strokeColor=#0f5132;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="620" y="40" width="320" height="140" as="geometry"/>
        </mxCell>

        <!-- Nodes (vertical order) -->
        <mxCell id="6" value="NEXUS_INTRO&#10;(nexus_intro_node) [graph 9.1]" style="rounded=1;fillColor=#e6550d;fontColor=#ffffff;strokeColor=#7a2b0a;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="40" y="200" width="220" height="60" as="geometry"/>
        </mxCell>

        <mxCell id="7" value="RECO_INTRO&#10;(reco_intro_node) [graph 9.2]" style="rounded=1;fillColor=#f97316;fontColor=#ffffff;strokeColor=#7c2d12;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="300" y="200" width="220" height="60" as="geometry"/>
        </mxCell>

        <mxCell id="8" value="STAT_INTRO&#10;(stat_intro_node) [graph 9.3]" style="rounded=1;fillColor=#f97316;fontColor=#ffffff;strokeColor=#7c2d12;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="560" y="200" width="220" height="60" as="geometry"/>
        </mxCell>

        <mxCell id="9" value="NEXUS_TOPIC_INTRO&#10;(nexus_topic_intro_node) [graph 9.4]&#10;calls generate_nexus_topic_intro() [lkk 7.3]" style="rounded=1;fillColor=#ff7f50;fontColor=#000000;strokeColor=#9b2c1b;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="820" y="200" width="320" height="80" as="geometry"/>
        </mxCell>

        <!-- Loop - Reco/Stat turns -->
        <mxCell id="10" value="RECO_TURN&#10;(reco_turn_node) [graph 9.5]&#10-> llm(SYSTEM_RECO) [lkk 2.x]" style="rounded=1;fillColor=#ffb84d;fontColor=#000000;strokeColor=#8a4b00;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="40" y="300" width="360" height="90" as="geometry"/>
        </mxCell>

        <mxCell id="11" value="STAT_TURN&#10;(stat_turn_node) [graph 9.6]&#10-> llm(SYSTEM_STAT) [lkk 2.x]" style="rounded=1;fillColor=#ffd580;fontColor=#000000;strokeColor=#8a4b00;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="440" y="300" width="360" height="90" as="geometry"/>
        </mxCell>

        <!-- Decision diamond -->
        <mxCell id="12" value="should_continue?&#10;state.current_turn >= max_turns" style="shape=diamond;whiteSpace=wrap;rounded=0;fillColor=#ffffff;strokeColor=#333333;fontColor=#000000;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="820" y="320" width="120" height="90" as="geometry"/>
        </mxCell>

        <mxCell id="13" value="NEXUS_OUTRO&#10;(nexus_outro_node) [graph 9.7]" style="rounded=1;fillColor=#ff6f61;fontColor=#ffffff;strokeColor=#8a2b25;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="980" y="300" width="260" height="90" as="geometry"/>
        </mxCell>

        <!-- Engine pipeline LLM -> SSML -> TTS -> Audio -->
        <mxCell id="14" value="LLM (AzureOpenAI)&#10;llm_safe / llm() [lkk 2.x]" style="rounded=1;fillColor=#d53e79;fontColor=#ffffff;strokeColor=#7a173b;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="40" y="420" width="260" height="80" as="geometry"/>
        </mxCell>

        <mxCell id="15" value="SSML utils&#10;text_to_ssml(), _inflect(), _clause_pauses [lkk 3.x]" style="rounded=1;fillColor=#06b6d4;fontColor=#ffffff;strokeColor=#0f4c56;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="340" y="420" width="320" height="80" as="geometry"/>
        </mxCell>

        <mxCell id="16" value="TTS Synth (Azure SDK)&#10;synth() -> wav segment [lkk 4.1]" style="rounded=1;fillColor=#0ea5e9;fontColor=#ffffff;strokeColor=#084b59;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="700" y="420" width="300" height="80" as="geometry"/>
        </mxCell>

        <mxCell id="17" value="Audio Processor&#10;segment management, write_master() [lkk 4.3]" style="rounded=1;fillColor=#7cfc00;fontColor=#000000;strokeColor=#3f6212;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="1040" y="420" width="320" height="80" as="geometry"/>
        </mxCell>

        <!-- Outputs -->
        <mxCell id="18" value="Outputs&#10;- podcast_YYYYMMDD.wav&#10;- podcast_script.txt&#10;- graph_convo.json&#10;- Mermaid HTML" style="rounded=1;fillColor=#8cc152;fontColor=#000000;strokeColor=#356b0b;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="1380" y="420" width="260" height="120" as="geometry"/>
        </mxCell>

        <!-- Monitoring -->
        <mxCell id="19" value="Monitoring / Viz&#10;- WebSocket server [graph 3.x]&#10;- timeline jsonl [graph 12.1]" style="rounded=1;fillColor=#ef4444;fontColor=#ffffff;strokeColor=#7f1d1d;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="820" y="540" width="320" height="120" as="geometry"/>
        </mxCell>

        <!-- External -->
        <mxCell id="20" value="External Services&#10;- Azure OpenAI&#10;- Azure Speech Service&#10;- Storage/CDN (future)" style="rounded=1;fillColor=#64748b;fontColor=#ffffff;strokeColor=#334155;fontSize=12;" vertex="1" parent="1">
          <mxGeometry x="40" y="560" width="320" height="120" as="geometry"/>
        </mxCell>

        <!-- EDGES with explicit geometry (relative) and step labels -->
        <mxCell id="e1" edge="1" parent="1" source="2" target="3" value="Step 1: entry -> config" style="edgeStyle=orthogonalEdgeStyle;rounded=0;endArrow=block;html=1;strokeColor=#111111;">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="e2" edge="1" parent="1" source="3" target="4" value="Step 2: config -> context" style="edgeStyle=orthogonalEdgeStyle;rounded=0;endArrow=block;html=1;strokeColor=#111111;">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="e3" edge="1" parent="1" source="4" target="5" value="Step 3: context -> orchestrator" style="edgeStyle=orthogonalEdgeStyle;rounded=0;endArrow=block;html=1;strokeColor=#111111;">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="e4" edge="1" parent="1" source="5" target="6" value="Start sequence" style="edgeStyle=orthogonalEdgeStyle;rounded=0;endArrow=block;html=1;strokeColor=#111111;">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="e5" edge="1" parent="1" source="6" target="7" value="then" style="edgeStyle=orthogonalEdgeStyle;rounded=0;endArrow=block;html=1;strokeColor=#111111;">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="e6" edge="1" parent="1" source="7" target="8" value="then" style="edgeStyle=orthogonalEdgeStyle;rounded=0;endArrow=block;html=1;strokeColor=#111111;">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="e7" edge="1" parent="1" source="8" target="9" value="then -> topic intro" style="edgeStyle=orthogonalEdgeStyle;rounded=0;endArrow=block;html=1;strokeColor=#111111;">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- topic intro & turns -> LLM -->
        <mxCell id="e8" edge="1" parent="1" source="9" target="14" value="LLM call: generate topic" style="edgeStyle=orthogonalEdgeStyle;rounded=0;endArrow=block;html=1;strokeColor=#6b21a8;">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="e9" edge="1" parent="1" source="5" target="10" value="Start turns loop" style="edgeStyle=orthogonalEdgeStyle;rounded=0;endArrow=block;html=1;strokeColor=#111111;">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="e10" edge="1" parent="1" source="10" target="11" value="next" style="edgeStyle=orthogonalEdgeStyle;rounded=0;endArrow=block;html=1;strokeColor=#111111;">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="e11" edge="1" parent="1" source="11" target="12" value="check condition" style="edgeStyle=orthogonalEdgeStyle;rounded=0;endArrow=block;html=1;strokeColor=#111111;">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="e12" edge="1" parent="1" source="12" target="10" value="no: continue" style="edgeStyle=orthogonalEdgeStyle;rounded=0;endArrow=block;html=1;strokeColor=#0b6623;">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="e13" edge="1" parent="1" source="12" target="13" value="yes: outro" style="edgeStyle=orthogonalEdgeStyle;rounded=0;endArrow=block;html=1;strokeColor=#b22222;">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- Reco/Stat -> LLM -> SSML -> TTS -> Audio -> Output -->
        <mxCell id="e14" edge="1" parent="1" source="10" target="14" value="LLM call (Reco)" style="edgeStyle=orthogonalEdgeStyle;rounded=0;endArrow=block;html=1;strokeColor=#6b21a8;">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e15" edge="1" parent="1" source="11" target="14" value="LLM call (Stat)" style="edgeStyle=orthogonalEdgeStyle;rounded=0;endArrow=block;html=1;strokeColor=#6b21a8;">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <mxCell id="e16" edge="1" parent="1" source="14" target="15" value="LLM -> SSML" style="edgeStyle=orthogonalEdgeStyle;rounded=0;endArrow=block;html=1;strokeColor=#111111;">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e17" edge="1" parent="1" source="15" target="16" value="SSML -> TTS synth()" style="edgeStyle=orthogonalEdgeStyle;rounded=0;endArrow=block;html=1;strokeColor=#111111;">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e18" edge="1" parent="1" source="16" target="17" value="wav segment" style="edgeStyle=orthogonalEdgeStyle;rounded=0;endArrow=block;html=1;strokeColor=#111111;">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e19" edge="1" parent="1" source="17" target="18" value="write_master() -> final WAV" style="edgeStyle=orthogonalEdgeStyle;rounded=0;endArrow=block;html=1;strokeColor=#111111;">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

        <!-- Monitoring & external -->
        <mxCell id="e20" edge="1" parent="1" source="5" target="19" value="Event -> WebSocket" style="edgeStyle=orthogonalEdgeStyle;rounded=0;endArrow=block;html=1;strokeColor=#6b7280;dashed=1;">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e21" edge="1" parent="1" source="14" target="20" value="uses" style="edgeStyle=orthogonalEdgeStyle;rounded=0;endArrow=block;html=1;strokeColor=#6b7280;dashed=1;">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>
        <mxCell id="e22" edge="1" parent="1" source="16" target="20" value="uses" style="edgeStyle=orthogonalEdgeStyle;rounded=0;endArrow=block;html=1;strokeColor=#6b7280;dashed=1;">
          <mxGeometry relative="1" as="geometry"/>
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
